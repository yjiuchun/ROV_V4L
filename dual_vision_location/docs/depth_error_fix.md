# 深度估计误差修正指南

## 问题描述
测量深度为1.7米，但实际深度为2.0米，误差约15%。

## 可能的原因

### 1. 基线长度不准确 ⭐ **最可能的原因**
- **当前配置**：基线 = 0.12米
- **需要的基线**：0.1412米（根据诊断工具计算）
- **原因**：如果基线设置偏小，会导致深度估计偏小

**修正方法**：
```yaml
# 在 stereo_calibration.yaml 中修改
stereo:
  T: [-0.1412, 0.0, 0.0]  # 从 -0.12 改为 -0.1412
```

### 2. 视差测量误差 ⭐⭐ **常见原因**
- **问题**：视差测量多计算了约5.05像素
- **原因**：
  - 特征点匹配不够精确
  - 特征点中心提取不准确
  - 左右图像中的点配对错误

**修正方法**：
1. **检查点配对**：确保左右图像中对应点的y坐标相同（或非常接近）
2. **提高匹配精度**：使用亚像素精度的特征点检测
3. **验证匹配**：可视化显示配对关系，确保正确

### 3. 未进行畸变校正 ⭐⭐⭐ **重要**
- **当前状态**：代码已更新支持畸变校正
- **影响**：畸变会导致像素坐标偏差，特别是图像边缘区域

**修正方法**：
代码已自动启用畸变校正（`use_undistort=True`）。如果仍有问题，检查：
- 畸变系数是否正确
- 畸变校正是否在三角测量前执行

### 4. 焦距不准确
- **当前焦距**：476.70像素
- **需要的焦距**：560.83像素（如果基线正确）
- **但**：焦距通常由相机标定确定，不应随意修改

## 推荐的修正步骤

### 步骤1：验证特征点匹配精度

```python
# 检查左右图像中对应点的y坐标是否对齐
for i in range(len(left_points)):
    y_diff = abs(left_points[i][1] - right_points[i][1])
    print(f"点{i}: y坐标差异 = {y_diff:.2f}像素")
    # 如果差异 > 1像素，可能存在匹配错误
```

### 步骤2：调整基线长度（如果确认其他参数正确）

根据诊断工具的建议，将基线调整为0.1412米：

```yaml
# stereo_calibration.yaml
stereo:
  T: [-0.1412, 0.0, 0.0]  # 修改这里
```

### 步骤3：进行图像畸变校正

代码已更新，会自动进行畸变校正。确保：
- `use_undistort=True`（默认已启用）
- 畸变系数配置正确

### 步骤4：使用已知距离进行校准

1. 放置一个已知距离的目标（例如2.0米）
2. 测量得到的深度
3. 计算修正系数：`修正系数 = 实际深度 / 测量深度 = 2.0 / 1.7 = 1.176`
4. 调整基线：`新基线 = 旧基线 × 修正系数 = 0.12 × 1.176 = 0.1412米`

### 步骤5：验证修正效果

修正后，再次测量已知距离的目标，验证精度。

## 深度误差的数学关系

```
Z_measured = (baseline × fx) / disparity_measured
Z_real = (baseline_real × fx_real) / disparity_real

如果 Z_measured / Z_real = 1.7 / 2.0 = 0.85

那么：
- 如果基线偏小，需要放大：baseline_new = baseline × (2.0/1.7) = 0.1412m
- 如果视差偏大，需要减小：disparity_new = disparity × (1.7/2.0)
- 如果焦距偏小，需要放大：fx_new = fx × (2.0/1.7) = 560.83px
```

## 调试技巧

### 1. 打印详细的视差信息

```python
# 在 triangulate_points 中添加
for i in range(len(left_points)):
    disparity = left_points[i][0] - right_points[i][0]
    depth_est = (baseline * fx) / disparity
    print(f"点{i}: 视差={disparity:.2f}px, 估计深度={depth_est:.3f}m")
```

### 2. 可视化特征点匹配

在图像上绘制配对关系，确保匹配正确。

### 3. 使用多个已知距离点进行验证

在不同距离（1m, 1.5m, 2m, 2.5m）放置目标，测量并比较。

## 注意事项

1. **基线长度**是最关键的参数，直接影响深度精度
2. **特征点匹配精度**对结果影响很大，特别是y坐标对齐
3. **畸变校正**是必要的，特别是在使用原始图像时
4. **ZED2相机**的实际基线可能不是标准的0.12米，需要实测或从SDK获取

## 快速修正命令

```bash
# 运行诊断工具
python3 scripts/diagnose_depth_error.py

# 根据诊断结果调整配置文件
# 编辑 config/stereo_calibration.yaml
```

